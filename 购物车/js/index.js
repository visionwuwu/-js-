var data = [{
        id: 1,
        name: '饮料',
        goods: [{
            id: 11,
            src: 'images/wm.png',
            title: '芬达',
            price: 3,
            num: 0
        }, {
            id: 12,
            src: 'images/wm.png',
            title: '可乐',
            price: 2.5,
            num: 0
        }, {
            id: 13,
            src: 'images/wm.png',
            title: '雪碧',
            price: 3,
            num: 0
        }]
    }, {
        id: 2,
        name: '水果',
        goods: [{
            id: 21,
            src: 'images/wm.png',
            title: '香蕉',
            price: 3,
            num: 0
        }, {
            id: 22,
            src: 'images/wm.png',
            title: '芒果',
            price: 7,
            num: 0
        }, {
            id: 23,
            src: 'images/wm.png',
            title: '苹果',
            price: 6,
            num: 0
        }]
    }, {
        id: 3,
        name: '冷冻食品',
        goods: [{
            id: 31,
            src: 'images/wm.png',
            title: '速冻饺子',
            price: 10,
            num: 0
        }, {
            id: 32,
            src: 'images/wm.png',
            title: '北美冻虾',
            price: 30,
            num: 0
        }, {
            id: 33,
            src: 'images/wm.png',
            title: '烧麦',
            price: 10,
            num: 0
        }, {
            id: 34,
            src: 'images/wm.png',
            title: '汤圆',
            price: 5,
            num: 0
        }]
    }, {
        id: 4,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    }, {
        id: 4,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    },
    {
        id: 5,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    },
    {
        id: 6,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    },
    {
        id: 7,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    },
    {
        id: 8,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    },
    {
        id: 9,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    },
    {
        id: 10,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    },
    {
        id: 11,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    },
    {
        id: 12,
        name: '猪肉',
        goods: [{
            id: 41,
            src: 'images/wm.png',
            title: '五花肉',
            price: 25,
            num: 0
        }, {
            id: 42,
            src: 'images/wm.png',
            title: '上等肋排',
            price: 35,
            num: 0
        }, {
            id: 43,
            src: 'images/wm.png',
            title: '土猪肉',
            price: 15,
            num: 0
        }, {
            id: 44,
            src: 'images/wm.png',
            title: '黑猪肉',
            price: 25,
            num: 0
        }]
    }
];

// 存储数据
let listData = JSON.parse(localStorage.getItem('cartData') || '[]');
// 本地没有添加数据到本地
if (!listData.length) {
    localStorage.setItem('cartData', JSON.stringify(data))
    listData = data
}

let cateList = document.getElementsByClassName('cart_cate')[0]
let cartList = document.getElementsByClassName('cart_list')[0]

showList();

function showList() {
    let cateTmp = ''
    let productTmp = ''

    // 循环遍历数据生成模板
    listData.forEach((item, index) => {

        // 分类模板
        cateTmp += `
        <li data-item="item${index + 1}" class="${index == 0 ? 'now' : ''}">${item.name}<span>1</span></li>
        `

        // 产品的数据模板
        productTmp += `
            <div class="item" id="item${index + 1}" data-id="${item.id}" data-index="${index}">
            <h3 class="tit">${item.name}</h3>
            `

        // 产品数据
        item.goods.forEach((list, i) => {
            productTmp += `
            <div class="product" data-id="${list.id}">
                <div class="pro_img"><img src="${list.src}" alt=""></div>
                <div class="pro_info">
                    <p class="pro_name">${list.title}</p>
                    <p class="pro_box">
                        <span class="pro_price">${list.price}元</span>
                        <em class="input_group">
                            <span class="sub" onclick="editPro(this)">-</span>
                            <b class="num">${list.num}</b>
                            <span class="add" onclick="editPro(this)">+</span>
                        </em>
                    </p>
                </div>
            </div>
        `
        })
        productTmp += '</div>'
    })

    // 添加到指定位置
    cateList.innerHTML = cateTmp
    cartList.innerHTML = productTmp


    // 找到每个cate li注册click事件
    let lis = cateList.querySelectorAll('li');
    let proItem = cartList.querySelectorAll('.item');
    lis.forEach(li => {
        li.addEventListener('click', handleClickCateLi, false)
    })

    // 获取每个offsetTop值
    let offsetTopArr = []
    proItem.forEach(pro => {
        offsetTopArr.push(pro.offsetTop + pro.offsetHeight)
    })

    function handleClickCateLi() {
        lis.forEach(li => {
            li.classList.remove('now')
        })
        this.classList.add('now')
        let id = this.dataset.item
        document.getElementById(id).scrollIntoView()
    }

    // 给cartList盒子注册onscroll事件
    cartList.onscroll = function(e) {
        var top = this.scrollTop

        var arr = offsetTopArr.filter(item => {
            return top >= item
        })

        lis.forEach(li => {
            li.classList.remove('now')
        })
        lis[arr.length].classList.add('now')
    }
}

var cateLis = document.querySelectorAll('.cart_cate li');

// 计算选中的数量
function computedNum(obj, target) {
    var sum = 0;
    obj.forEach(item => {
        sum += Number(item.innerText)
    })
    target.style.display = sum == 0 ? 'none' : 'block'
    target.innerText = sum
}

// 渲染数量
function renderNum() {
    var citems = document.querySelector('.cart_list').querySelectorAll('.item')
    citems.forEach((item, index) => {
        computedNum(item.querySelectorAll('.num'), cateLis[index].lastElementChild)
    })
}


// 添加和删除商品
function editPro(btn) {
    var clsName = btn.className
    var numObj = btn.parentElement.querySelector('.num')
    var val = Number(numObj.innerText);
    // 添加
    if (clsName.includes('add')) {
        val = val + 1
    }
    // 减少
    if (clsName.includes('sub')) {
        val = val - 1
    }
    // 商品数量不能小于零
    if (val < 0) {
        val = 0
    }

    numObj.innerText = val;
    // 添加动画
    if (val > 0) {
        btn.parentElement.classList.add('scroll')
    } else {
        btn.parentElement.classList.remove('scroll')
    }

    // 每个cateLi对应的数量和
    var id1 = Number(btn.closest('.item').dataset.id)
    var id2 = Number(btn.closest('.product').dataset.id)
    var index = Number(btn.closest('.item').dataset.index)
    var numObjs = btn.closest('.item').querySelectorAll('.num')

    // 改变选的数量
    computedNum(numObjs, cateLis[index].lastElementChild)

    // 找到对应的产品
    var oneData = listData.filter(oneItem => {
        return oneItem.id == id1
    })
    var twoData = oneData[0].goods.filter(twoItem => {
        return twoItem.id == id2
    })

    // 改变数量
    twoData[0].num = val

    // 重新计算总价钱
    computedAll()

    // 存储到本地
    localStorage.setItem('cartData', JSON.stringify(listData))

}

// 计算总价钱和总数量
function computedAll() {
    var totalBox = document.querySelector('.totalNum');
    var moneyBox = document.querySelector('.sellPrice');
    var num = 0;
    var money = 0;
    for (let i = 0; i < listData.length; i++) {
        var goods = listData[i].goods
        for (let j = 0; j < goods.length; j++) {
            num += goods[j].num;
            money += goods[j].num * goods[j].price
        }
    }
    totalBox.innerText = num
    moneyBox.innerText = money.toFixed(2)
}

window.onload = function() {
    renderNum()
    computedAll()
}